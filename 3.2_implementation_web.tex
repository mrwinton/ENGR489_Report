%!TEX root = proj_report_outline.tex
\chapter{Web Application Implementation}\label{C:webApplicationImplementation}

\section{Implementation Details}
The standard web application functionality required within the prototype, such as authentication, request life-cycles and password resets, was straightforward as Ruby on Rails solves many of these problems, and offers a wealth of libraries that can assist. The Pitch Card functionality and scope of disclosure functionality described in the Sections \ref{C:requirements} and \ref{C:design_web} were implemented from the ground up. In this Section these two functionality item's implementation details are explored.

\subsection{Pitch Card System}
As exemplified in Section \ref{C:requirements} Callaghan Innovation's specification for how the Pitch Card system works was quite mature and detailed. At it's core it required that users be able to initiate Pitch Cards and browse Pitch Cards, with the further ability to contribute suggestions or comments. To do this the web application separates the action's responsibilities. As discussed in Section \ref{SS:frameworkSelection} Ruby on Rails is architected on the MVC architecture pattern. Following Ruby on Rails convention the PitchHub prototype has models, views and controllers for each resource. The controllers adhere to the RESTful design principles, where resources are accessed using conventional HTTP resource methods and relationships are expressed via resource-nesting. The models, as designed in Figure \ref{fig:class_diagram}, were implemented with the Mongoid \cite{Mongo4:online} Object Document Mapper (ODM) for MongoDB. The Mongoid ODM subscribes to the ``convention over configuration'' philosophy that is held highly in the Ruby on Rails framework, offering a simple fa√ßade over the MongoDB query language. The views were implemented with HTML, SASS (CSS), and JavaScript. To enhance the user experience AJAX was implemented to speed up page load times by loading secondary or non-essential data asynchronously. AJAX was also heavily used in user interactions, such as contributing a suggestion/comment and setting disclosure scopes (as an initiator).
\par
Figure \ref{fig:pitch_card_pitchhub} showcases the prototype's Pitch Card view from the initiator's perspective. The view can be deconstructed as follows: the sidebar contains the links to the main pages, the navigation bar contains the search box and user management drop-down, the main page space contains the Pitch Card and it's associated suggestions. Figure \ref{fig:dashboard_pitchhub} contains the same sidebar and navigation bar however the main page space contains a grid of mini-pitch card views consisting of the Pitch Card's image (if any) as well as the \textit{Value Proposition} pitch point.

\subsection{Scope of Disclosure}
As previously discussed in Section \ref{S:systemModel} and shown in Figure \ref{fig:class_diagram} the scope of disclosure functionality is implemented on both Pitch Card and Suggestion/Comment models. For Pitch Cards this scope of disclosure is achieved through a combined effort at the database level and at the application level. To illustrate this consider the \ref{fig:dashboard_pitchhub}. When the user loads up the dashboard the database is queried asking for Pitch Cards that the current user is able to see (if any). How this first step works is through the use of MongoDB's aggregation pipeline \cite{Aggre7:online}. The aggregation pipeline in this instance deals with the fact that users assume different roles in the context of different Pitch Cards, and Pitch Cards themselves are heterogeneous in the scopes they are defined with. Unlike role-based Access Control Lists, where a user is checked if their role satisfies a particular permission level, the pipeline designed for PitchHub checks the user against each role of the Pitch Card and then against the Pitch Card's visibility scope. This single pipeline aggregation query basically checks a matrix of constraints to check each context. This is visualised in Figure \ref{fig:pipeline}.

\begin{figure}[ht]
    \centering
    \includegraphics[width=1\textwidth]{pipeline}
    \caption{The pipeline aggregation query used to find all visible Pitch Cards checks for the scoping of the Pitch Card from the context of the current user.}
    \label{fig:pipeline}
\end{figure}

Continuing the example above, once the viewable Pitch Cards for the Dashboard view have been retrieved from the database the application applies the identity scopes for each Pitch Card in the view. This piece of functionality decides whether the the initiator will appear by their name or by `anonymous'. The way this is implemented is made simple through the ODM, where when the Pitch Card object is retrieved, the Pitch Card's nested scope objects are also retrieved. As seen in Figure \ref{fig:class_diagram} these scope objects implement the strategy pattern, so when they are retrieved the application is able to easily check whether the current user is authorised to see the Pitch Card's author agnostic of the actual scope being used. The use of the strategy pattern removes the need to do the less-pragmatic and less-extensible type-checking on scope objects to determine what scoping business logic should be used.
\par
The marriage of database-level and application-level scoping caters to the context of the request's life-cycle stage to maximise efficiency. Certainly, it would have been possible to use the strategy pattern object scoping instead of what is essentially type-checking in the aggregation pipeline query to achieve this scoping. However, at this point in the request the application does not have Pitch Card objects (and their nested scope objects) to scope by, therefore by expressing this logic in the database query the application is able to appropriately apply scope given the context, retrieving only the viewable Pitch Cards.

\section{Implementation Challenges}

\subsection{Virtualised Environment}
The time-constrained weekly/bi-weekly meetings with Callaghan Innovation elicited the need for their own locally hosted PitchHub instances. Their own PitchHub instances enabled them to check the progress of the prototype, answer UI/UX questions, and show the prototype to other Callaghan Innovation personnel. 
\par
Personally configuring the environment and setting up PitchHub was an option, however this would have still been a lengthy process detracting from actual meeting. Furthermore it would have been infeasible to repeat this for each stakeholder and their various machines. Requiring the stakeholders to do this themselves would have similarly been infeasible as configuring a locally hosted Ruby on Rails application is a non-trivial task \cite{Roma:personalCommunications}, to exemplify this StackOverflow has excess of 50,000 questions in relation to Ruby on Rails installation/configuration \cite{StackOverflowProblem1:online}\cite{StackOverflowProblem2:online}\cite{StackOverflowProblem3:online}\cite{StackOverflowProblem4:online}.
\par
To solve this problem the PitchHub environment and installation process was automated using a combination of Chef and Vagrant. Specifically, the Vagrant configuration sets up an Ubuntu virtual machine with routing configured for local access and Chef downloads and installs PitchHub's dependencies (Ruby, a JS runtime, and MongoDB). By having this infrastructure/configuration implemented via code it also serves as documentation for the PitchHub environment and also enables the use of version control within this aspect of the project as well. This process has the further advantage in that any future contributors to the project will have a very low barrier to entry.

\subsection{Deployment}
As discussed in Section \ref{S:projectObjectives} one of the objectives was to have a prototype deployed by August so that Callaghan Innovation may conduct an internal user study. Deploying PitchHub onto the world wide web turned out to be a fairly time-consuming challenge. Callaghan Innovation kindly provided the hardware, racked the machines in their server room, and also configured the firewall. Prior to this experience I had only limited experience in deploying web-applications and my knowledge was limited to that of using Heroku, a platform as a service provider \cite{Herok1:online}. In deploying PitchHub I learnt how to set up an nginx HTTP server \cite{nginx2:online} with the Phusion Passenger application server \cite{phusionPassenger:online} and also configure SSL. The primary pain point in deploying PitchHub was with the actual code deployment. In deploying a Ruby on Rails application there are a few common options: SFTP into the server and transfer the files manually or using Capistrano \cite{capistrano:online} to automate the deployment. These approaches have different strengths and weaknesses. The manual SFTP option has a very low barrier to entry, as it essentially just a method that copies locally selected files/directories files onto the server, on the downside it is also a very brittle process, as it requires one to remember to pre-compile the assets and check that the local copy is the correct version of the application to be deployed. The Capistrano approach is similar to Vagrant in that the entire process is defined in code. Being automated is the greatest advantage to deploying with Capistrano as we can ensure each deployment fulfils each task correctly and in order, and should the process require more tasks these can be easily added. The problem with Capistrano is that it requires a deep knowledge of the framework. Ultimately, I decided to use Capistrano as automation is an attribute that appeals to me, as the initial investment is negligible in comparison to the long term gains of robust and consistent deployments. PitchHub is currently hosted at \textit{pitchhub.net}, note that the current release is being used internally in Callaghan Innovation and requires an access code to sign up.

\begin{sidewaysfigure}[ht]
    \centering
    \includegraphics[width=1\textwidth]{pitch_card_pitchhub}
    \caption{Fictional Ford Model T Pitch Card view from the initiator's perspective. The view is divided into two sections the Pitch Card and it's suggestions/comments. In the Pitch Card half users perform in-line editing on a Pitch Point to make a suggestion. In the suggestion/comments half the initiator may accept or decline the suggestion and set the suggestion/comment's scope.}
    \label{fig:pitch_card_pitchhub}
\end{sidewaysfigure}

\begin{sidewaysfigure}[ht]
    \centering
    \includegraphics[width=1\textwidth]{dashboard_pitchhub}
    \caption{PitchHub's dashboard populated with fictional Pitch Cards. The grid layout displayed is responsive, so the Pitch Cards will reorganise and size to fit the user's device screen.}
    \label{fig:dashboard_pitchhub}
\end{sidewaysfigure}